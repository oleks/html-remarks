<!DOCTYPE HTML>
<html>
<head>
<title>Remarks</title>
<style type="text/css">
html input {
  font-family: monospace;
  font-size: 1.3em;
}
input {
  border: 0;
  border-bottom: 1px solid gray;
}
.mood {
  cursor: pointer; cursor: hand;
  padding: 0 0.5em;
  font-size: 1.5em;
  font-family: monospace;
}
h1 span {
  padding-right: 0.3em;
}
ol li {
  list-style-type: none;
}
ol {
  padding: 0;
  padding-left: 1em;
}
</style>
</head>
<body>
<div id="remarks"></div>
<script type="text/javascript">

function byId(id) {
  return document.getElementById(id);
}

const remarks_elem = byId("remarks");

var next = {j: 0, t: 0};

function gen(id) {
  return id + (next[id]++).toString(10);
}

function setValue(elem) {
  elem.setAttribute("value", elem.value);
}

function toggleMood(elem) {
  var current_mood = elem.innerText;
  var next_mood = "*";
  switch (current_mood) {
  case "*":
    next_mood = "+";
    break;
  case "+":
    next_mood = "-";
    break;
  case "-":
    next_mood = "?";
    break;
  }
  elem.innerText = next_mood;
  elem.nextSibling.focus();
}

function appendTextInput(container) {
  var input = document.createElement("input");
  input.setAttribute("type", "text");
  input.setAttribute("onchange", "setValue(this);");

  container.appendChild(input);

  return input;
}

function appendMood(container) {
  var span = document.createElement("span");
  span.className = "mood";
  span.innerText = "*";
  span.setAttribute("onclick", "toggleMood(this);");
  container.appendChild(span);
}

function removeAllChildren(elem) {
  for (var i = 0; i < elem.children.length; i++) {
    console.log(elem.children[0]);
    elem.removeChild(elem.children[0]);
  }
}

function findRemarks(elem) {
  for (var i = 0; i < elem.children.length; i++) {
    if (elem.children[i].tagName == "OL") {
      return elem.children[i]; 
    }
  }
  return null;
}

function getRemarks(elem) {
  var remarks = findRemarks(elem);
  if (remarks == null) {
    remarks = appendRemarks(elem);
  }
  return remarks;
}

function indentRemark(row, elem) {
  var row_elem = byId(row);
  if (row_elem.previousSibling != null) {
    var remarks = getRemarks(row_elem.previousSibling);
    row_elem.parentNode.removeChild(row_elem);
    remarks.appendChild(row_elem);
    elem.focus();
  }
}

function unindentRemark(row, elem) { 
  var row_elem = byId(row);
  if (row_elem.parentNode &&
      row_elem.parentNode.parentNode &&
      row_elem.parentNode.parentNode.parentNode) {
    var new_next = row_elem.parentNode.parentNode.nextSibling;
    var new_parent = row_elem.parentNode.parentNode.parentNode;
    if (new_parent.tagName == "OL") {
      row_elem.parentNode.removeChild(row_elem);
      if (new_next != null) {
        new_parent.insertBefore(row_elem, new_next);
      } else {
        new_parent.appendChild(row_elem);
      }
      elem.focus();
    }
  }
}

function moveRemarkUp(row, elem) {
  var row_elem = byId(row);
  var prev = row_elem.previousSibling;
  if (prev != null) {
    var parentNode = row_elem.parentNode;
    parentNode.removeChild(row_elem);
    parentNode.insertBefore(row_elem, prev); 
    elem.focus();
  }
}

function moveRemarkDown(row, elem) {
  var row_elem = byId(row);
  var next = row_elem.nextSibling;
  if (next != null) {
    var parentNode = row_elem.parentNode;
    parentNode.removeChild(row_elem);
    nextnext = next.nextSibling;
    if (nextnext != null) {
      parentNode.insertBefore(row_elem, nextnext); 
    } else {
      parentNode.appendChild(row_elem);
    }
    elem.focus();
  }
}

function tryRemoveRemark(row, elem) {
  if (elem.value != "") {
    return;
  }

  var row_elem = byId(row);
  var sibling = row_elem.previousSibling;
  if (sibling == null) {
    sibling = row_elem.nextSibling;
  }
  if (sibling == null) {
    return;
  }

  row_elem.parentNode.removeChild(row_elem);
  sibling.children[1].focus();
}

var ctrl_pressed = null;

function remarkKeydown(row, e, elem) {
  if (e.code === "Enter") {
    var row_elem = byId(row);
    appendRemark(row_elem.parentNode, row_elem);
  } else if (e.code == "Backspace") {
    tryRemoveRemark(row, elem);
  } else if (e.key == "Control") {
    ctrl_pressed = elem;
  } else if (ctrl_pressed === elem && e.code == "Space") {
    toggleMood(elem.previousSibling);
  } else if (ctrl_pressed === elem && e.key == "ArrowRight") {
    indentRemark(row, elem);
  } else if (ctrl_pressed === elem && e.key == "ArrowLeft") {
    unindentRemark(row, elem);
  } else if (ctrl_pressed === elem && e.key == "ArrowUp") {
    moveRemarkUp(row, elem);
  } else if (ctrl_pressed === elem && e.key == "ArrowDown") {
    moveRemarkDown(row, elem);
  }
}

function sectionKeydown(section, e, elem) {
  if (e.code === "Enter") {
    var section_elem = byId(section);
    var depth = parseInt(section_elem.children[0].tagName.substring(1), 10);
    appendSection(section_elem.parentNode, depth);
  }
}

function handleKeyup(e, elem) {
  if (ctrl_pressed === elem && e.key == "Control") {
    ctrl_pressed = null;
  }
}

function appendRemark(container, prev) {
  var row = document.createElement("li");
  row.id = gen("j");

  appendMood(row);

  var input = appendTextInput(row);
  input.setAttribute("onkeydown",
    "remarkKeydown(\"" + row.id + "\", event, this);");
  input.setAttribute("onkeyup",
    "handleKeyup(event, this);");

  if (prev === undefined || prev === null) {
    container.appendChild(row);
  } else {
    container.insertBefore(row, prev.nextSibling);
  }
  input.focus();
}

function appendRemarks(container) {
  var remarks = document.createElement("ol");
  remarks.id = gen("t");
  container.appendChild(remarks);
  return remarks;
}

function appendSection(container, depth) {
  var section = document.createElement("section");
  section.id = gen("s");

  var header = document.createElement("h" + depth);

  var span = document.createElement("span");
  span.innerText = Array(depth + 1).join("#");
  header.appendChild(span);

  var input = appendTextInput(header);
  input.setAttribute("onkeydown",
    "sectionKeydown(\"" + section.id + "\", event, this);");

  section.appendChild(header);

  appendRemark(appendRemarks(section));

  container.appendChild(section);
  input.focus();
}

if (remarks_elem.children.length === 0) {
  appendSection(remarks_elem, 1);
}

function getFilename() {
  var parts = document.location.href.split("?")[0].split("/");
  var last = parts[parts.length - 1];
  return last.split(".html")[0];
}

document.title = getFilename();

</script>
</body>
</html>
