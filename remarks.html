<!DOCTYPE HTML>
<html>
<head>
<title>Remarks</title>
<style type="text/css">
html input {
  font-family: monospace;
  font-size: 1.3em;
}
input {
  border: 0;
  border-bottom: 1px dashed gray;
}
.mood {
  cursor: pointer; cursor: hand;
  padding: 0 0.5em;
  font-size: 1.5em;
}
ol li {
  list-style-type: none;
}
ol {
  padding: 0;
}
</style>
</head>
<body>
<div id="remarks"></div>
<script type="text/javascript">

function byId(id) {
  return document.getElementById(id);
}

const remarks_elem = byId("remarks");

var next = {j: 0, t: 0};

function gen(id) {
  return id + (next[id]++).toString(10);
}

function setValue(elem) {
  elem.setAttribute("value", elem.value);
}

function changeMood(elem) {
  var current_mood = elem.innerText;
  var next_mood = "*";
  switch (current_mood) {
  case "*":
    next_mood = "+";
    break;
  case "+":
    next_mood = "-";
    break;
  case "-":
    next_mood = "?";
    break;
  }
  elem.innerText = next_mood;
}

function appendTextInput(container) {
  var input = document.createElement("input");
  input.setAttribute("type", "text");
  input.setAttribute("onchange", "setValue(this);");

  container.appendChild(input);

  return input;
}

function appendMood(container) {
  var span = document.createElement("span");
  span.className = "mood";
  span.innerText = "*";
  span.setAttribute("onclick", "changeMood(this);");
  container.appendChild(span);
}

function handleKeydown(row, e, elem) {
  console.log(e.code);
  if (e.code === "Enter") {
    var row_elem = byId(row);
    appendJudgement(row_elem.parentNode, row_elem);
  } else if (e.code == "Backspace" && elem.value == "") {
    var row_elem = byId(row);
    row_elem.parentNode.removeChild(row_elem);
  }
}

function appendJudgement(container, prev) {
  var row = document.createElement("li");
  row.id = gen("j");

  appendMood(row);

  input = appendTextInput(row);
  input.setAttribute("onkeydown",
    "handleKeydown(\"" + row.id + "\", event, this);");

  if (prev === undefined || prev === null) {
    container.appendChild(row);
  } else {
    container.insertBefore(row, prev.nextSibling);
  }
  input.focus();
}

function appendSection(container, depth) {
  var section = document.createElement("section");

  var header = document.createElement("h" + depth);
  appendTextInput(header);
  section.appendChild(header);

  var judgements = document.createElement("ol");
  judgements.id = gen("t");
  appendJudgement(judgements);
  section.appendChild(judgements);

  container.appendChild(section);
}

if (remarks_elem.children.length === 0) {
  appendSection(remarks_elem, 1);
}

function getFilename() {
  var parts = document.location.href.split("?")[0].split("/");
  var last = parts[parts.length - 1];
  return last.split(".html")[0];
}

document.title = getFilename();

</script>
</body>
</html>
