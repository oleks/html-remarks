<!DOCTYPE HTML>
<html>
<head>
<title>Remarks</title>
<style type="text/css">
html input {
  font-family: monospace;
  font-size: 1.3em;
}
input {
  border: 0;
  border-bottom: 1px solid gray;
}
.mood {
  cursor: pointer; cursor: hand;
  padding: 0 0.5em;
  font-size: 1.5em;
  font-family: monospace;
}
ol li {
  list-style-type: none;
}
ol {
  padding: 0;
  padding-left: 1em;
}
</style>
</head>
<body>
<div id="remarks"></div>
<script type="text/javascript">

function byId(id) {
  return document.getElementById(id);
}

const remarks_elem = byId("remarks");

var next = {j: 0, t: 0};

function gen(id) {
  return id + (next[id]++).toString(10);
}

function setValue(elem) {
  elem.setAttribute("value", elem.value);
}

function toggleMood(elem) {
  var current_mood = elem.innerText;
  var next_mood = "*";
  switch (current_mood) {
  case "*":
    next_mood = "+";
    break;
  case "+":
    next_mood = "-";
    break;
  case "-":
    next_mood = "?";
    break;
  }
  elem.innerText = next_mood;
  elem.nextSibling.focus();
}

function appendTextInput(container) {
  var input = document.createElement("input");
  input.setAttribute("type", "text");
  input.setAttribute("onchange", "setValue(this);");

  container.appendChild(input);

  return input;
}

function appendMood(container) {
  var span = document.createElement("span");
  span.className = "mood";
  span.innerText = "*";
  span.setAttribute("onclick", "toggleMood(this);");
  container.appendChild(span);
}

function removeAllChildren(elem) {
  for (var i = 0; i < elem.children.length; i++) {
    console.log(elem.children[0]);
    elem.removeChild(elem.children[0]);
  }
}

function findJudgements(elem) {
  for (var i = 0; i < elem.children.length; i++) {
    if (elem.children[i].tagName == "OL") {
      return elem.children[i]; 
    }
  }
  return null;
}

function getJudgements(elem) {
  var judgements = findJudgements(elem);
  if (judgements == null) {
    judgements = appendJudgements(elem);
  }
  return judgements;
}

function goRight(row, elem) {
  var row_elem = byId(row);
  if (row_elem.previousSibling != null) {
    var judgements = getJudgements(row_elem.previousSibling);
    row_elem.parentNode.removeChild(row_elem);
    judgements.appendChild(row_elem);
    elem.focus();
  }
}

function goLeft(row, elem) { 
  var row_elem = byId(row);
  if (row_elem.parentNode &&
      row_elem.parentNode.parentNode &&
      row_elem.parentNode.parentNode.parentNode) {
    var new_next = row_elem.parentNode.parentNode.nextSibling;
    var new_parent = row_elem.parentNode.parentNode.parentNode;
    if (new_parent.tagName == "OL") {
      row_elem.parentNode.removeChild(row_elem);
      if (new_next != null) {
        new_parent.insertBefore(row_elem, new_next);
      } else {
        new_parent.appendChild(row_elem);
      }
      elem.focus();
    }
  }
}

function goUp(row, elem) {
  var row_elem = byId(row);
  var prev = row_elem.previousSibling;
  if (prev != null) {
    var parentNode = row_elem.parentNode;
    parentNode.removeChild(row_elem);
    parentNode.insertBefore(row_elem, prev); 
    elem.focus();
  }
}

function goDown(row, elem) {
  var row_elem = byId(row);
  var next = row_elem.nextSibling;
  if (next != null) {
    var parentNode = row_elem.parentNode;
    parentNode.removeChild(row_elem);
    nextnext = next.nextSibling;
    if (nextnext != null) {
      parentNode.insertBefore(row_elem, nextnext); 
    } else {
      parentNode.appendChild(row_elem);
    }
    elem.focus();
  }
}

function tryRemoveJudgement(row, elem) {
  if (elem.value != "") {
    return;
  }

  var row_elem = byId(row);
  var sibling = row_elem.previousSibling;
  if (sibling == null) {
    sibling = row_elem.nextSibling;
  }
  if (sibling == null) {
    return;
  }

  row_elem.parentNode.removeChild(row_elem);
  sibling.children[1].focus();
}

var ctrl_pressed = null;

function judgementKeydown(row, e, elem) {
  if (e.code === "Enter") {
    var row_elem = byId(row);
    appendJudgement(row_elem.parentNode, row_elem);
  } else if (e.code == "Backspace") {
    tryRemoveJudgement(row, elem);
  } else if (e.key == "Control") {
    ctrl_pressed = elem;
  } else if (ctrl_pressed === elem && e.code == "Space") {
    toggleMood(elem.previousSibling);
  } else if (ctrl_pressed === elem && e.key == "ArrowRight") {
    goRight(row, elem);
  } else if (ctrl_pressed === elem && e.key == "ArrowLeft") {
    goLeft(row, elem);
  } else if (ctrl_pressed === elem && e.key == "ArrowUp") {
    goUp(row, elem);
  } else if (ctrl_pressed === elem && e.key == "ArrowDown") {
    goDown(row, elem);
  }
}

function handleKeyup(e, elem) {
  if (ctrl_pressed === elem && e.key == "Control") {
    ctrl_pressed = null;
  }
}

function appendJudgement(container, prev) {
  var row = document.createElement("li");
  row.id = gen("j");

  appendMood(row);

  var input = appendTextInput(row);
  input.setAttribute("onkeydown",
    "judgementKeydown(\"" + row.id + "\", event, this);");
  input.setAttribute("onkeyup",
    "handleKeyup(event, this);");

  if (prev === undefined || prev === null) {
    container.appendChild(row);
  } else {
    container.insertBefore(row, prev.nextSibling);
  }
  input.focus();
}

function appendJudgements(container) {
  var judgements = document.createElement("ol");
  judgements.id = gen("t");
  container.appendChild(judgements);
  return judgements;
}

function appendSection(container, depth) {
  var section = document.createElement("section");

  var header = document.createElement("h" + depth);
  appendTextInput(header);
  section.appendChild(header);

  appendJudgement(appendJudgements(section));

  container.appendChild(section);
  input.focus();
}

if (remarks_elem.children.length === 0) {
  appendSection(remarks_elem, 1);
}

function getFilename() {
  var parts = document.location.href.split("?")[0].split("/");
  var last = parts[parts.length - 1];
  return last.split(".html")[0];
}

document.title = getFilename();

</script>
</body>
</html>
